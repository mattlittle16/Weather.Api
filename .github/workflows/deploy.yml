name: Deploy to Homelab

on:
  push:
    branches: [ master ]  
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Unlock git-crypt
      run: |
         # Unlock using the key from secrets
         echo "${{ secrets.GIT_CRYPT_KEY }}" | base64 -d > /tmp/git-crypt-key
         git-crypt unlock /tmp/git-crypt-key
         rm /tmp/git-crypt-key

    - name: Stop existing container (if running)
      run: |
        docker stop weatherapi || true
        docker rm weatherapi || true
      continue-on-error: true
    
    - name: Build Docker image
      run: |
         docker build -t weatherapi:latest ./src
    
    - name: Run new container
      run: |
        docker run -d \
          --name weatherapi \
          --restart always \
          --network app-network \
          -e ASPNETCORE_ENVIRONMENT=Production \
          -e ASPNETCORE_URLS=http://+:80 \
          -e AppSettings__OpenWeatherApiKey=${{ secrets.OPENWEATHERMAP_API_KEY }} \
          -e AppSettings__XApiKey=${{ secrets.XAPI_KEY }} \
          -e AppSettings__OpenWeatherApiBaseUrl=${{ secrets.OPENWEATHERMAP_API_BASE_URL }} \
          weatherapi:latest
    
    - name: Verify deployment
      run: |
         sleep 5
         curl -f http://localhost/healthcheck || exit 1

    - name: Clean up old images
      run: |
        docker image prune -f